name: Kaffe CI
on:
  push:
    branches:
      - master

  pull_request:

env:
  ELIXIR_DEPS_CACHE_NAME: elixir-deps-cache-v1

jobs:

  test:
    runs-on: ubuntu-latest
    env:
      MIX_ENV: test
    strategy:
      matrix:
        otp: ["22.3.4.23", "23.3.4.9", "24.1.7"]
        elixir: ["1.7.4", "1.13.1"]
        exclude:
          - otp: 24.1.7
            elixir: 1.7.4
          - otp: 22.3.4.23
            elixir: 1.13.1
    steps:
      - uses: erlef/setup-beam@v1
        with:
          otp-version: ${{matrix.otp}}
          elixir-version: ${{matrix.elixir}}
      - uses: actions/checkout@v2
      - name: Cache deps and hex
        uses: actions/cache@v2
        with:
          path: |
            ~/.hex
            ~/.mix
            _build
            deps
          key: $${{ env.ELIXIR_DEPS_CACHE_NAME }}-${{ runner.os }}-${{ matrix.otp }}-${{ matrix.elixir }}-${{ hashFiles('**/mix.lock') }}
      - name: Dependencies
        shell: bash
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix do deps.get, deps.compile
      - name: Compile
        run: |
          mix compile
      - name: Test
        run: |
          mix test --trace
      # - name: Credo
      #   run: |
      #     mix credo --all --strict
      - name: Check formatting
        if: matrix.elixir != '1.7.4'
        run: |
          mix format --check-formatted
      # - name: Dialyzer
      #   run: |
      #     env MIX_ENV=dev mix dialyzer
